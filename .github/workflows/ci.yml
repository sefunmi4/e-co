name: CI

on: [push, pull_request]

jobs:
  javascript:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: Config
            workspace: packages/config
            vitest_config: ''
            playwright_config: ''
            build_command: npm run build -w packages/config
            lint_command: npm run lint -w packages/config
          - name: Ethos Frontend
            workspace: apps/web/ethos/frontend
            vitest_config: apps/web/ethos/frontend/vitest.config.ts
            playwright_config: ''
            build_command: ''
            lint_command: ''
          - name: Ether Pod
            workspace: apps/web/ether-pod
            vitest_config: apps/web/ether-pod/vitest.config.ts
            playwright_config: apps/web/ether-pod/playwright.config.ts
            build_command: ''
            lint_command: ''
          - name: Ethos Playwright Flow
            workspace: apps/web/ether-pod
            vitest_config: ''
            playwright_config: apps/web/ethos/tests/playwright.config.ts
            build_command: ''
            lint_command: ''
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci --workspace ${{ matrix.workspace }}
      - name: Validate Ether Pod assets
        if: ${{ matrix.workspace == 'apps/web/ether-pod' }}
        run: npm run check:assets -w apps/web/ether-pod
      - name: Lint workspace
        if: ${{ matrix.lint_command != '' }}
        run: ${{ matrix.lint_command }}
      - name: Build workspace
        if: ${{ matrix.build_command != '' }}
        run: ${{ matrix.build_command }}
      - name: Run Vitest
        if: ${{ matrix.vitest_config != '' }}
        run: npx vitest run --config ${{ matrix.vitest_config }}
      - name: Install Playwright Browsers
        if: ${{ matrix.playwright_config != '' }}
        working-directory: ${{ matrix.workspace }}
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        if: ${{ matrix.playwright_config != '' }}
        run: npx playwright test --config ${{ matrix.playwright_config }}

  nix:
    runs-on: ubuntu-latest
    needs: javascript
    steps:
      - uses: actions/checkout@v3
      - uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-23.11
      - run: nix build .#packages.x86_64-linux.isoImage --accept-flake-config
      - run: nix build .#packages.x86_64-linux.qtExample --accept-flake-config
